rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Function to validate image upload
    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
        && request.resource.size <= 5 * 1024 * 1024; // 5MB max
    }

    // Function to check if user is a dealer - simplified version
    function isDealerUser() {
      let userDoc = get(/databases/(default)/documents/users/$(request.auth.uid));
      return userDoc != null;  // Temporarily remove role check
    }

    // Dealer profile assets rules - simplified for debugging
    match /dealer-assets/{userId}/{imageType} {
      // Allow read for everyone (public dealer profiles)
      allow read: if true;
      
      // Allow write with simplified checks
      allow write: if isAuthenticated() 
        && request.auth.uid == userId  // User can only modify their own files
        && isValidImage()  // Must be a valid image
        && (imageType == 'logo' || imageType == 'banner');  // Must be logo or banner
    }

    // Deny access to all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 