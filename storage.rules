rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Function to check if user is a dealer
    function isDealer() {
      let userId = request.auth.uid;
      let userDoc = firestore.get(/databases/(default)/documents/users/$(userId));
      return userDoc != null && userDoc.data.role == 'dealer';
    }

    // Function to check if user is a dealer OR regular user (both can upload)
    function isDealerOrUser() {
      let userId = request.auth.uid;
      let userDoc = firestore.get(/databases/(default)/documents/users/$(userId));
      return userDoc != null && 
             (userDoc.data.role == 'dealer' || userDoc.data.role == 'user');
    }

    // Function to validate image upload
    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
        && request.resource.size <= 5 * 1024 * 1024; // 5MB max
    }

    // Function to check if dealer owns the vehicle
    function ownsVehicle(vehicleId) {
      return true; // Allow initial upload since Firestore document doesn't exist yet
    }

    // Vehicles collection rules
    match /vehicles/{vehicleId}/{imageFile} {
      // Allow read for everyone (public listings)
      allow read: if true;
      
      // Allow write for authenticated dealers and users
      allow write: if isAuthenticated() 
        && isDealerOrUser()
        && isValidImage();
    }

    // Dealer profile assets rules
    match /dealer-assets/{userId}/{imageType} {
      // Allow read for everyone (public dealer profiles)
      allow read: if true;
      
      // Allow write with checks
      allow write: if isAuthenticated() 
        && request.auth.uid == userId  // User can only modify their own files
        && isValidImage()  // Must be a valid image
        && (imageType == 'logo' || imageType == 'banner');  // Must be logo or banner
    }

    // Deny access to all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
} 