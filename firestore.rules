rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is an admin
    function isAdmin() {
      let adminEmails = request.auth.token.email in ['abelsajuchazhoor@gmail.com'];
      let isInAdminsCollection = exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      return adminEmails || isInAdminsCollection;
    }

    // Function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Function to check if user is email verified
    function isEmailVerified() {
      return request.auth.token.email_verified == true;
    }

    // Function to check if user is a dealer
    function isDealer() {
      let userDoc = get(/databases/(default)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null && userDoc.data.role == 'dealer';
    }

    // Function to check if user is a dealer OR regular user (both can create listings)
    function isDealerOrUser() {
      let userDoc = get(/databases/(default)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null && 
             (userDoc.data.role == 'dealer' || userDoc.data.role == 'user');
    }

    // Function to validate vehicle data
    function isValidVehicleData() {
      let requiredFields = ['make', 'model', 'year', 'price', 'mileage', 'type', 'dealerUid'];
      return request.resource.data.keys().hasAll(requiredFields) 
        && request.resource.data.dealerUid == request.auth.uid
        && request.resource.data.type in ['car', 'van', 'truck'];
    }

    // Function to validate dealer profile data
    function isValidDealerProfile() {
      let requiredFields = ['businessName', 'contact', 'description', 'location', 'businessHours', 'socialMedia', 'updatedAt'];
      let data = request.resource.data;
      
      return data.keys().hasAll(requiredFields)
        && data.contact.keys().hasAll(['email', 'phone', 'website'])
        && data.location.keys().hasAll(['lat', 'long', 'addressLines'])
        && data.businessHours.keys().hasAll(['mondayToFriday', 'saturday', 'sunday'])
        && data.description.size() <= 2000 // Approx. 100 words
        && data.socialMedia is list;
    }

    // Function to check if dealer owns the vehicle listing
    function ownsVehicle() {
      return resource.data.dealerUid == request.auth.uid;
    }

    // Users collection rules
    match /users/{userId} {
      // Allow read if user is authenticated
      allow read: if request.auth != null;
      // Allow create during signup (no verification required)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow update if user is admin, or if it's the user's own document and they're verified
      // Exception: Allow unverified users to update their emailVerified status
      allow update: if isAdmin() || 
        (request.auth.uid == userId && 
          (isEmailVerified() || 
           (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emailVerified'])))
        );
    }

    // Admins collection rules
    match /admins/{adminId} {
      // Allow read if user is authenticated
      allow read: if request.auth != null;
      // Allow write only if user is an admin
      allow write: if isAdmin();
    }

    // Vehicles collection rules
    match /vehicles/{vehicleId} {
      // Allow read for everyone (public listings)
      allow read: if true;
      
      // Allow list operation for verified dealers and users querying their own listings
      allow list: if isAuthenticated() 
        && isEmailVerified()
        && isDealerOrUser()
        && request.query.limit <= 100  // Limit query size for security
        && (
          // Allow if no where clause (getting all listings)
          !('where' in request.query)
          // Or if querying by dealerUid matching their own ID
          || (
            request.query.where.size() == 1
            && request.query.where[0].op == '=='
            && request.query.where[0].field == 'dealerUid'
            && request.query.where[0].value == request.auth.uid
          )
        );
      
      // Allow create for authenticated and verified dealers and users with valid data
      allow create: if (isAuthenticated() 
        && isEmailVerified()
        && isDealerOrUser()
        && isValidVehicleData()) || isAdmin();
      
      // Allow update/delete for verified dealers and users who own the listing or admins
      allow update: if (isAuthenticated() 
        && isEmailVerified()
        && isDealerOrUser()
        && ownsVehicle()
        && isValidVehicleData()) || isAdmin();
        
      allow delete: if (isAuthenticated() 
        && isEmailVerified()
        && isDealerOrUser()
        && ownsVehicle()) || isAdmin();
    }

    // Dealers collection rules
    match /dealers/{userId} {
      // Allow read for everyone (public dealer profiles)
      allow read: if true;
      
      // Allow write for verified dealers' own profile or admins
      allow write: if (isAuthenticated() 
        && isEmailVerified()
        && isDealer()
        && request.auth.uid == userId
        && isValidDealerProfile()) || isAdmin();
    }

    // Dealer profile assets rules
    match /dealer-assets/{userId}/{imageType} {
      // Allow read for everyone (public dealer profiles)
      allow read: if true;
      
      // Allow write for verified dealers' own profile images or admins
      allow write: if (isAuthenticated() 
        && isEmailVerified()
        && request.auth.uid == userId
        && isDealerUser()
        && isValidImage()
        // Ensure imageType is either 'logo' or 'banner'
        && (imageType == 'logo' || imageType == 'banner')) || isAdmin();
    }

    // Favorites collection rules
    match /favorites/{userId} {
      // Users can only read and write their own favorites if verified
      allow read, write: if (isAuthenticated() 
        && isEmailVerified() 
        && request.auth.uid == userId) || isAdmin();
    }

    // Keep existing rules for other collections
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}